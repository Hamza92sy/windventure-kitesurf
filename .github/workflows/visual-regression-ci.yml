name: ğŸ¨ Visual Regression Pipeline

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Analyse quotidienne de windventure.fr Ã  6h00 UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      target_url:
        description: 'URL Ã  analyser (par dÃ©faut: windventure.fr)'
        required: false
        default: 'https://windventure.fr'

env:
  NODE_VERSION: '18'
  PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/ms-playwright

jobs:
  # Job 1: Analyse visuelle automatique
  visual-analysis:
    name: ğŸ” Analyse Visuelle Automatique
    runs-on: ubuntu-latest
    
    outputs:
      issues-count: ${{ steps.analysis.outputs.issues-count }}
      critical-issues: ${{ steps.analysis.outputs.critical-issues }}
      
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: |
          npm ci
          npm install --save-dev puppeteer

      - name: ğŸ—ï¸ Build application (si local)
        if: github.event.inputs.target_url == '' || contains(github.event.inputs.target_url, 'localhost')
        run: |
          npm run build
          npm run start &
          sleep 10
          curl -f http://localhost:3000 || exit 1
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      - name: ğŸ” Run Visual Analysis
        id: analysis
        run: |
          TARGET_URL="${{ github.event.inputs.target_url || 'https://windventure.fr' }}"
          
          # Si c'est un build local, utiliser localhost
          if [[ -z "${{ github.event.inputs.target_url }}" ]] && [[ "${{ github.event_name }}" != "schedule" ]]; then
            TARGET_URL="http://localhost:3000"
          fi
          
          echo "Analyzing: $TARGET_URL"
          BASE_URL="$TARGET_URL" node scripts/visual-analysis.js || true
          
          # Extraire les mÃ©triques du rapport
          if [ -f visual-debug-report.json ]; then
            ISSUES_COUNT=$(cat visual-debug-report.json | jq '.summary.total')
            CRITICAL_ISSUES=$(cat visual-debug-report.json | jq '.summary.critical')
            echo "issues-count=$ISSUES_COUNT" >> $GITHUB_OUTPUT
            echo "critical-issues=$CRITICAL_ISSUES" >> $GITHUB_OUTPUT
          else
            echo "issues-count=0" >> $GITHUB_OUTPUT
            echo "critical-issues=0" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¸ Upload Screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-screenshots
          path: |
            visual-debug-*.png
            visual-debug-report.json
          retention-days: 7

      - name: ğŸš¨ Comment PR with Visual Issues
        if: github.event_name == 'pull_request' && steps.analysis.outputs.issues-count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const issuesCount = ${{ steps.analysis.outputs.issues-count }};
            const criticalIssues = ${{ steps.analysis.outputs.critical-issues }};
            
            const body = `## ğŸ¨ Analyse Visuelle
            
            ğŸ“Š **RÃ©sultats:**
            - ğŸ” ProblÃ¨mes dÃ©tectÃ©s: ${issuesCount}
            - ğŸš¨ Critiques: ${criticalIssues}
            
            ${criticalIssues > 0 ? 'âŒ **Des problÃ¨mes critiques nÃ©cessitent votre attention**' : 'âœ… Aucun problÃ¨me critique'}
            
            ğŸ“¸ Consultez les screenshots dans les artifacts de ce build.
            
            <details>
            <summary>ğŸ”§ Actions recommandÃ©es</summary>
            
            1. TÃ©lÃ©chargez les artifacts pour voir les screenshots
            2. Lancez localement: \`npm run debug:visual\`
            3. Appliquez les corrections: \`npm run auto-fix:visual\`
            4. Re-testez et re-committez
            
            </details>`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # Job 2: Tests de rÃ©gression visuelle multi-browsers
  visual-regression:
    name: ğŸ“¸ Tests RÃ©gression Visuelle
    runs-on: ubuntu-latest
    needs: visual-analysis
    if: always()
    
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
        viewport: [desktop, tablet, mobile]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ­ Install Playwright
        run: |
          npx playwright install --with-deps ${{ matrix.browser }}

      - name: ğŸ—ï¸ Build application
        run: |
          npm run build
          npm run start &
          sleep 10
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      - name: ğŸ“¸ Run Visual Regression Tests
        run: |
          VIEWPORT=${{ matrix.viewport }} npx playwright test visual-regression --project=${{ matrix.browser }}
        continue-on-error: true

      - name: ğŸ“Š Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-results-${{ matrix.browser }}-${{ matrix.viewport }}
          path: |
            test-results/
            playwright-report/
          retention-days: 7

  # Job 3: Auto-correction automatique
  auto-fix:
    name: ğŸ”§ Tentative de Correction Automatique
    runs-on: ubuntu-latest
    needs: visual-analysis
    if: needs.visual-analysis.outputs.critical-issues > 0 && github.event_name != 'schedule'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ“¥ Download Analysis Report
        uses: actions/download-artifact@v4
        with:
          name: visual-screenshots

      - name: ğŸ› ï¸ Run Auto-Fix
        run: |
          node scripts/auto-fix-visual.js

      - name: ğŸ“¤ Create Fix Pull Request
        if: success()
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ğŸ”§ Auto-fix: Corrections visuelles automatiques"
          title: "ğŸ¤– Auto-Fix: ProblÃ¨mes visuels dÃ©tectÃ©s et corrigÃ©s"
          body: |
            ## ğŸ”§ Corrections Automatiques AppliquÃ©es
            
            Ce PR a Ã©tÃ© gÃ©nÃ©rÃ© automatiquement suite Ã  la dÃ©tection de ${{ needs.visual-analysis.outputs.critical-issues }} problÃ¨me(s) critique(s).
            
            ### ğŸ” Analyse complÃ¨te
            - **ProblÃ¨mes totaux:** ${{ needs.visual-analysis.outputs.issues-count }}
            - **ProblÃ¨mes critiques:** ${{ needs.visual-analysis.outputs.critical-issues }}
            
            ### âœ… Corrections appliquÃ©es
            Les corrections suivantes ont Ã©tÃ© appliquÃ©es automatiquement :
            - ğŸ¨ Configuration Tailwind CSS optimisÃ©e
            - ğŸ“± Fixes responsive pour mobile/tablet
            - ğŸ–¼ï¸ Composants d'images optimisÃ©s avec fallbacks
            - ğŸ“ Corrections des dÃ©bordements de layout
            - âš¡ Optimisations de performance Next.js
            
            ### ğŸ§ª Tests requis
            - [ ] VÃ©rifier le build : `npm run build`
            - [ ] Tester visuellement sur desktop/mobile
            - [ ] Relancer l'analyse : `npm run debug:visual`
            - [ ] Valider les performances Lighthouse
            
            ### âš ï¸ Attention
            - Ce sont des corrections automatiques - vÃ©rifiez avant de merger
            - Testez particuliÃ¨rement sur mobile et les images
            - Les sauvegardes sont dans les fichiers `backup-*`
            
            ---
            ğŸ¤– GÃ©nÃ©rÃ© automatiquement par le workflow Visual Regression CI
          branch: auto-fix/visual-issues-${{ github.run_number }}
          delete-branch: true

  # Job 4: Performance & Lighthouse audit
  performance-audit:
    name: âš¡ Audit Performance & Visuel
    runs-on: ubuntu-latest
    needs: visual-analysis
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build application
        run: |
          npm run build
          npm run start &
          sleep 10

      - name: ğŸ” Lighthouse CI
        uses: treosh/lighthouse-ci-action@v12
        with:
          configPath: './lighthouse.config.js'
          uploadArtifacts: true
          temporaryPublicStorage: true
        continue-on-error: true

      - name: ğŸ“Š Web Vitals Check
        run: |
          # Installer lighthouse en CLI
          npm install -g lighthouse chrome-launcher
          
          # Lancer lighthouse et extraire les mÃ©triques
          lighthouse http://localhost:3000 --output=json --output-path=lighthouse-report.json --chrome-flags="--headless" --quiet
          
          # Analyser les rÃ©sultats
          node -e "
          const report = require('./lighthouse-report.json');
          const metrics = report.audits;
          
          const fcp = metrics['first-contentful-paint'].numericValue;
          const lcp = metrics['largest-contentful-paint'].numericValue;
          const cls = metrics['cumulative-layout-shift'].numericValue;
          const perfScore = report.categories.performance.score * 100;
          
          console.log('ğŸ“Š Web Vitals:');
          console.log('Performance Score:', perfScore.toFixed(1) + '%');
          console.log('FCP:', fcp + 'ms (seuil: <2000ms)');
          console.log('LCP:', lcp + 'ms (seuil: <3000ms)');  
          console.log('CLS:', cls.toFixed(3) + ' (seuil: <0.1)');
          
          // Ã‰chec si seuils critiques dÃ©passÃ©s
          const failures = [];
          if (perfScore < 85) failures.push('Performance Score < 85%');
          if (fcp > 2000) failures.push('FCP > 2s');
          if (lcp > 3000) failures.push('LCP > 3s');
          if (cls > 0.1) failures.push('CLS > 0.1');
          
          if (failures.length > 0) {
            console.log('âŒ Ã‰checs:', failures.join(', '));
            process.exit(1);
          } else {
            console.log('âœ… Toutes les mÃ©triques passent');
          }
          "

      - name: ğŸ“Š Upload Lighthouse Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-report
          path: lighthouse-report.json

  # Job 5: Notification et intÃ©gration Notion
  notify-and-integrate:
    name: ğŸ“‹ Notifications & IntÃ©gration
    runs-on: ubuntu-latest
    needs: [visual-analysis, visual-regression, performance-audit]
    if: always()
    
    steps:
      - name: ğŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4

      - name: ğŸ“¤ Update Notion Database
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
        if: env.NOTION_API_KEY != ''
        run: |
          # Calculer le statut global
          VISUAL_STATUS="âœ… OK"
          if [ "${{ needs.visual-analysis.outputs.critical-issues }}" -gt "0" ]; then
            VISUAL_STATUS="âŒ ProblÃ¨mes critiques"
          elif [ "${{ needs.visual-analysis.outputs.issues-count }}" -gt "0" ]; then
            VISUAL_STATUS="âš ï¸ ProblÃ¨mes mineurs"
          fi
          
          # Mettre Ã  jour Notion
          curl -X PATCH "https://api.notion.com/v1/pages/${{ secrets.NOTION_PAGE_ID }}" \
            -H "Authorization: Bearer ${{ secrets.NOTION_API_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            -d "{
              \"properties\": {
                \"Visual Status\": {
                  \"rich_text\": [{
                    \"text\": { \"content\": \"$VISUAL_STATUS\" }
                  }]
                },
                \"Last Visual Check\": {
                  \"date\": {
                    \"start\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
                  }
                },
                \"Issues Count\": {
                  \"number\": ${{ needs.visual-analysis.outputs.issues-count || 0 }}
                },
                \"Critical Issues\": {
                  \"number\": ${{ needs.visual-analysis.outputs.critical-issues || 0 }}
                }
              }
            }"

      - name: ğŸš¨ Slack Notification
        if: failure() || needs.visual-analysis.outputs.critical-issues > 0
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
              -H 'Content-type: application/json' \
              --data "{
                \"text\": \"ğŸš¨ ProblÃ¨mes visuels dÃ©tectÃ©s sur Windventure.fr\",
                \"attachments\": [
                  {
                    \"color\": \"danger\",
                    \"fields\": [
                      {
                        \"title\": \"Repository\",
                        \"value\": \"${{ github.repository }}\",
                        \"short\": true
                      },
                      {
                        \"title\": \"Branch\",
                        \"value\": \"${{ github.ref_name }}\",
                        \"short\": true
                      },
                      {
                        \"title\": \"ProblÃ¨mes critiques\",
                        \"value\": \"${{ needs.visual-analysis.outputs.critical-issues }}\",
                        \"short\": true
                      },
                      {
                        \"title\": \"Total problÃ¨mes\",
                        \"value\": \"${{ needs.visual-analysis.outputs.issues-count }}\",
                        \"short\": true
                      }
                    ],
                    \"actions\": [
                      {
                        \"type\": \"button\",
                        \"text\": \"Voir les screenshots\",
                        \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
                      }
                    ]
                  }
                ]
              }"
          fi

      - name: âœ… Success Notification
        if: success() && needs.visual-analysis.outputs.critical-issues == 0
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
              -H 'Content-type: application/json' \
              --data "{
                \"text\": \"âœ… Tests visuels Windventure.fr rÃ©ussis\",
                \"attachments\": [
                  {
                    \"color\": \"good\",
                    \"fields\": [
                      {
                        \"title\": \"Status\",
                        \"value\": \"Tous les tests visuels passent\",
                        \"short\": false
                      }
                    ]
                  }
                ]
              }"
          fi

      - name: ğŸ“Š Performance Summary
        run: |
          echo "## ğŸ“Š RÃ©sumÃ© de l'analyse visuelle" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ProblÃ¨mes dÃ©tectÃ©s:** ${{ needs.visual-analysis.outputs.issues-count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ProblÃ¨mes critiques:** ${{ needs.visual-analysis.outputs.critical-issues }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL analysÃ©e:** ${{ github.event.inputs.target_url || 'https://windventure.fr' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.visual-analysis.outputs.critical-issues }}" -gt "0" ]; then
            echo "âŒ **Action requise:** Des problÃ¨mes critiques nÃ©cessitent votre attention" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Statut:** Aucun problÃ¨me critique dÃ©tectÃ©" >> $GITHUB_STEP_SUMMARY
          fi